<!DOCTYPE html>
<html>
<head>
  <title>Map Area & Perimeter Calculator</title>
  <style>
    body, html {
      margin: 0;
      padding: 0;
      height: 100%;
      display: flex;
      flex-direction: column;
      font-family: Arial, sans-serif;
    }
    #toolbar {
      background: #fff;
      padding: 8px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      border-bottom: 1px solid #ccc;
      z-index: 1000;
    }
    #map {
      flex: 1;
      width: 100%;
    }
#results {
  background: #f9f9f9;
  padding: 10px;
  border-top: 1px solid #ccc;
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 12px;
}

/* Each card */
.result-card {
  border: 2px solid;
  border-radius: 10px;
  padding: 12px;
  font-size: 14px;
  background: #fff;
  transition: all 0.2s ease-in-out;
}

/* Highlight active shape */
.result-card.active {
  background: #ffe599;
  font-weight: bold;
}

    .highlight-row {
  background-color: #ffe599 !important;
  font-weight: bold;
}

    button, select {
      padding: 6px 10px;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <!-- Toolbar Controls -->
  <div id="toolbar">
    <button onclick="undo()">‚Ü©Ô∏è Undo</button>
    <button onclick="redo()">‚Ü™Ô∏è Redo</button>
    <button onclick="clearShapes()">üóëÔ∏è Clear All</button>
    <button onclick="deleteSelected()">‚ùå Delete Selected</button>
    <button onclick="downloadPDF()">üìÑ Download Report</button>
    <select id="regionPreset" onchange="applyPreset()">
      <option value="punjab">üåæ Punjab (Kanal/Marla/Bigha)</option>
      <option value="international">üåç International (Acre/Hectare)</option>
    </select>
  </div>

  <!-- Map Container -->
  <div id="map"></div>

  <!-- Results -->
  <div id="results"></div>

  <!-- Google Maps API -->
  <script src="https://maps.googleapis.com/maps/api/js?key=&libraries=drawing,geometry"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    let map, drawingManager, selectedShape;
    let allShapes = [];
    let undoStack = [], redoStack = [];

// Random color generator
    function getRandomColor() {
      const colors = ["#FF5733","#33FF57","#3357FF","#F39C12","#8E44AD","#16A085","#E74C3C","#2C3E50","#D35400","#1ABC9C"];
      return colors[Math.floor(Math.random() * colors.length)];
    }

// Initialize Map in HYBRID mode
    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 30.7333, lng: 76.7794 },
        zoom: 12,
        mapTypeId: "hybrid", // satellite + labels
      });

// Drawing tools
      drawingManager = new google.maps.drawing.DrawingManager({
        drawingMode: null,
        drawingControl: true,
        drawingControlOptions: {
          position: google.maps.ControlPosition.TOP_LEFT,
          drawingModes: ['polygon','rectangle']
        },
        polygonOptions: { editable: true, draggable: true },
        rectangleOptions: { editable: true, draggable: true },
        
      });
      drawingManager.setMap(map);

// On shape complete
      google.maps.event.addListener(drawingManager, 'overlaycomplete', function(event) {
        const newShape = event.overlay;
        let color = getRandomColor();
        newShape.setOptions({
          strokeColor: color,
          fillColor: color,
          fillOpacity: 0.3
        });
        newShape.color = color; // store color with shape
        newShape.type = event.type;
        newShape.label = new google.maps.InfoWindow();

        let shapeName = prompt("Enter name for this shape:", "Plot " + (allShapes.length + 1));
        newShape.shapeName = shapeName || "Plot " + (allShapes.length + 1);

        allShapes.push(newShape);
        saveState();
        setSelection(newShape);

        if (event.type === google.maps.drawing.OverlayType.POLYGON) {
          let path = newShape.getPath();
          google.maps.event.addListener(path, 'set_at', () => { saveState(); updateMeasurements(); });
          google.maps.event.addListener(path, 'insert_at', () => { saveState(); updateMeasurements(); });
          google.maps.event.addListener(path, 'remove_at', () => { saveState(); updateMeasurements(); });
        } else if (event.type === google.maps.drawing.OverlayType.RECTANGLE) {
          google.maps.event.addListener(newShape, 'bounds_changed', () => { saveState(); updateMeasurements(); });
        }

        updateMeasurements();

        google.maps.event.addListener(newShape, 'click', function() {
          setSelection(newShape);
        });
      });

// Deselect shape on map click
      google.maps.event.addListener(map, 'click', clearSelection);
    }
// Clear selection
    function clearSelection() {
      if (selectedShape) {
        selectedShape.setEditable(false);
        resetShapeStyle(selectedShape);
        selectedShape = null;
      }
    }
// Select a shape
    function setSelection(shape) {
      clearSelection();
      selectedShape = shape;
      shape.setEditable(true);
      highlightShape(shape);
      highlightCard(allShapes.indexOf(shape));

    }
// Highlight shape
    function highlightShape(shape) {
      shape.setOptions({ strokeColor: "#000000", strokeWeight: 3 });
    }

// Reset style of a shape
    function resetShapeStyle(shape) {
      shape.setOptions({ strokeColor: shape.color, strokeWeight: 2 });
    }

// Clear all shape
    function clearShapes() {
      allShapes.forEach(s => { s.setMap(null); if (s.label) s.label.close(); });
      allShapes = [];
      document.getElementById("results").innerHTML = "";
      saveState();
    }

// Highlight card
    function highlightCard(index) {
      document.querySelectorAll(".result-card").forEach(c => c.classList.remove("active"));
      const card = document.getElementById("card-" + index);
      if (card) card.classList.add("active");
    }


// Delete selected shape
    function deleteSelected() {
      if (selectedShape) {
        selectedShape.setMap(null);
        if (selectedShape.label) selectedShape.label.close();
        allShapes = allShapes.filter(s => s !== selectedShape);
        selectedShape = null;
        saveState();
        updateMeasurements();
      } else {
        alert("No shape selected!");
      }
    }

// Update measurements of all shapes
    function updateMeasurements() {
      let totalArea = 0, totalPerimeter = 0;
      let region = document.getElementById("regionPreset").value;
      let html = "";

      allShapes.forEach((shape, i) => {
        let area = 0, perimeter = 0, center;

        if (shape.type === google.maps.drawing.OverlayType.POLYGON) {
          area = google.maps.geometry.spherical.computeArea(shape.getPath());
          perimeter = google.maps.geometry.spherical.computeLength(shape.getPath());
          let bounds = new google.maps.LatLngBounds();
          shape.getPath().forEach(p => bounds.extend(p));
          center = bounds.getCenter();
        } else if (shape.type === google.maps.drawing.OverlayType.RECTANGLE) {
          const bounds = shape.getBounds();
          const ne = bounds.getNorthEast();
          const sw = bounds.getSouthWest();
          const nw = new google.maps.LatLng(ne.lat(), sw.lng());
          const se = new google.maps.LatLng(sw.lat(), ne.lng());
          const path = [ne, nw, sw, se];
          area = google.maps.geometry.spherical.computeArea(path);
          perimeter = google.maps.geometry.spherical.computeLength(path);
          center = bounds.getCenter();
        }

        totalArea += area;
        totalPerimeter += perimeter;

// label results
        let text2 = (region === "punjab")
          ? `Kanal ${(area/505.857).toFixed(2)} <br> Marla ${(area/25.2929).toFixed(1)} <br> Bigha ${(area/1008.72).toFixed(2)} <br> Biswa ${(area/50.436).toFixed(2)} `
          : `Acres ${(area/4046.856).toFixed(2)} <br> Hectare ${(area/10000).toFixed(2)}`;

// Result section
        let text = `<b>${shape.shapeName}</b><br>`;
        text += `Area: ${area.toFixed(2)} m¬≤<br>`;
        text += `Perimeter: ${perimeter.toFixed(2)} m<br>`;
        text += `Square feet: ${(area*10.7639).toFixed(2)} ft¬≤<br>`;

        if (region === "punjab") {
          text += `Marla ${(area/25.2929).toFixed(2)} <br>`;
          text += `Kanal ${(area/505.857).toFixed(2)} <br>`;
          text += `Bigha ${(area/1008.72).toFixed(2)} <br>`;
          text += `Biswa ${(area/50.436).toFixed(2)} <br>`;
        } else {
          text += `Acres ${(area/4046.856).toFixed(2)} <br>`;
          text += `Hectare ${(area/10000).toFixed(2)} <br>`;
        }

// label in map
        if (shape.label) {
          shape.label.setContent(`<div style="font-size:12px;font-weight:bold;"><center>${shape.shapeName}</center> ${text2}</div>`);
          shape.label.setPosition(center);
          shape.label.open(map);
        }

// Final Result as card
        html += `
          <div class="result-card" id="card-${i}" style="border-color:${shape.color}">
            ${text}
          </div>
        `;
      });

      html += `
  <div class="result-card" style="border-color:#000">
    <b>Total Area:</b> ${totalArea.toFixed(2)} m¬≤<br>
    <b>Total Perimeter:</b> ${totalPerimeter.toFixed(2)} m
  </div>
`;
      document.getElementById("results").innerHTML = html;
    }

    function applyPreset() { updateMeasurements(); }

    function saveState() {
      undoStack.push(allShapes.map(s => s)); // clone reference
      redoStack = [];
    }

// Undo last action
    function undo() {
      if (undoStack.length > 1) {
        redoStack.push(undoStack.pop());
        restoreState(undoStack[undoStack.length - 1]);
      }
    }

// Redo last undone action
    function redo() {
      if (redoStack.length > 0) {
        const state = redoStack.pop();
        undoStack.push(state);
        restoreState(state);
      }
    }

    function restoreState(state) {
      allShapes.forEach(s => s.setMap(null));
      allShapes = state.map(s => s);
      allShapes.forEach(s => s.setMap(map));
      updateMeasurements();
    }

// Download results as PDF
    function downloadPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.setFontSize(16);
      doc.text("Map Area & Perimeter Report", 10, 20);
      const results = document.getElementById("results").innerText;
      doc.setFontSize(12);
      doc.text(results, 10, 40);
      doc.save("area-report.pdf");
    }

// Init map on page load
    window.onload = initMap;
  </script>
</body>
</html>
